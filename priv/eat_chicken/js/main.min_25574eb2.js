var __reflect=this&&this.__reflect||function(t,e,i){t.__class__=e,i?i.push(e):i=[e],t.__types__=t.__types__?i.concat(t.__types__):i},__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);i.prototype=e.prototype,t.prototype=new i},__awaiter=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(r,o){function s(t){try{h(n.next(t))}catch(e){o(e)}}function a(t){try{h(n["throw"](t))}catch(e){o(e)}}function h(t){t.done?r(t.value):new i(function(e){e(t.value)}).then(s,a)}h((n=n.apply(t,e||[])).next())})},__generator=this&&this.__generator||function(t,e){function i(t){return function(e){return n([t,e])}}function n(i){if(r)throw new TypeError("Generator is already executing.");for(;h;)try{if(r=1,o&&(s=o[2&i[0]?"return":i[0]?"throw":"next"])&&!(s=s.call(o,i[1])).done)return s;switch(o=0,s&&(i=[0,s.value]),i[0]){case 0:case 1:s=i;break;case 4:return h.label++,{value:i[1],done:!1};case 5:h.label++,o=i[1],i=[0];continue;case 7:i=h.ops.pop(),h.trys.pop();continue;default:if(s=h.trys,!(s=s.length>0&&s[s.length-1])&&(6===i[0]||2===i[0])){h=0;continue}if(3===i[0]&&(!s||i[1]>s[0]&&i[1]<s[3])){h.label=i[1];break}if(6===i[0]&&h.label<s[1]){h.label=s[1],s=i;break}if(s&&h.label<s[2]){h.label=s[2],h.ops.push(i);break}s[2]&&h.ops.pop(),h.trys.pop();continue}i=e.call(t,h)}catch(n){i=[6,n],o=0}finally{r=s=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}var r,o,s,a,h={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return a={next:i(0),"throw":i(1),"return":i(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a},ItemUtils=function(t){function e(e,i,n){return t.call(this)||this}return __extends(e,t),e.createBitmapById=function(t){var e=new egret.Bitmap,i=RES.getRes(this.items["id_"+t].png);return e.texture=i,e.width=70,e.height=70,e},e.createItemById=function(t){var e=new Item(this.items["id_"+t].png);return e.setId(t),e},e.getItemNameById=function(t){var e=this.items["id_"+t].name;return e},e.items={id_0:{name:"",png:"empty_png"},id_1:{name:"炸弹",png:"explosive_png"},id_2:{name:"",png:"gun4_png"},id_3:{name:"手枪",png:"gun1_png"},id_4:{name:"步枪",png:"gun2_png"},id_5:{name:"超级步枪",png:"gun4_png"},id_6:{name:"一级防具",png:"shield1_png"},id_7:{name:"二级防具",png:"shield2_png"},id_8:{name:"三级防具",png:"shield3_png"},id_9:{name:"决斗卡",png:"battle_png"},id_10:{name:"复活卡",png:"life_png"},id_11:{name:"药箱",png:"aid_png"},id_12:{name:"急救箱",png:"first_aid_png"},id_13:{name:"",png:"money_png"},id_14:{name:"黄金矿点",png:"gold_png"}},e}(egret.HashObject);__reflect(ItemUtils.prototype,"ItemUtils");var Board=function(t){function e(e,i){var n=t.call(this)||this;return n.playerContainer=new egret.DisplayObjectContainer,n.colorMatrix=[.3,.6,0,0,0,.3,.6,0,0,0,.3,.6,0,0,0,0,0,0,1,0],n.createBoard(e,i),n}return __extends(e,t),e.prototype.createBoard=function(t,e){this.cellList=[];for(var i=0;t>i;i++)for(var n=0;e>n;n++){var r=this.createCell(i,n,this.cellList.length);this.addChild(r)}this.addChild(this.playerContainer)},e.prototype.createCell=function(t,e,i){var n=new Cell(t,e,i);return this.cellList.push(n),n},e.prototype.createBitmapByName=function(t){var e=new egret.Bitmap,i=RES.getRes(t);return e.texture=i,e},e.prototype.getCellList=function(){return this.cellList},e.prototype.getCellById=function(t){return __awaiter(this,void 0,void 0,function(){var e;return __generator(this,function(i){switch(i.label){case 0:return[4,this.cellList.filter(function(e){return e.getID()==t})];case 1:return e=i.sent(),[2,e[0]]}})})},e.prototype.getCellByXY=function(t,e){return __awaiter(this,void 0,void 0,function(){var i;return __generator(this,function(n){switch(n.label){case 0:return[4,this.cellList.filter(function(i){var n=i.getXY();return n.x==t&&n.y==e})];case 1:return i=n.sent(),[2,i[0]]}})})},e.prototype.putPlayer=function(t){this.playerContainer.addChild(t)},e.prototype.clearPlayers=function(){this.playerContainer.removeChildren()},e.prototype.removePlayer=function(t){this.playerContainer.removeChild(t)},e.prototype.setIndex=function(t,e){this.playerContainer.setChildIndex(t,e)},e}(egret.DisplayObjectContainer);__reflect(Board.prototype,"Board");var Game=function(t){function e(){var e=t.call(this)||this;return e._touchStatus=!1,e._distance=new egret.Point,e.textfield=new egret.TextField,e.tmxTileMap=tiled.TMXTilemap,e._route=new egret.Shape,e._life=new egret.Shape,e.soilderIconList=[],e.board=null,e.backgroundMusic=new egret.Sound,e.playerInfo=new egret.Shape,e.player_name=new egret.TextField,e.player_hp=new egret.TextField,e.player_attack=new egret.TextField,e.player_defense=new egret.TextField,e.player_eos=new egret.TextField,e.player_item=new egret.TextField,e.player_weapon=new egret.TextField,e.safeAreaTop=new egret.Shape,e.safeAreaLeft=new egret.Shape,e.safeAreaRight=new egret.Shape,e.safeAreaBottom=new egret.Shape,e.playerProfileListContainer=new egret.DisplayObjectContainer,e.honorListContainer=new egret.DisplayObjectContainer,e.honorListBox=new egret.Shape,e.honorListText=new egret.TextField,e.summaryContainer=new egret.DisplayObjectContainer,e.summaryBox=new egret.Shape,e.summaryContent=new egret.TextField,e.messageContainer=new egret.DisplayObjectContainer,e.messageBox=new egret.Shape,e.message=new egret.TextField,e.townRandomName=["johny","kitty","peter"],e.num=0,e.interval=null,e.messageTimeout=null,e.poisons=[],e.canvas=document.getElementsByTagName("CANVAS")[0],e.addEventListener(egret.Event.ADDED_TO_STAGE,e.onAddToStage,e),e}return __extends(e,t),e.prototype.onAddToStage=function(t){egret.lifecycle.addLifecycleListener(function(t){t.onUpdate=function(){}}),egret.lifecycle.onPause=function(){egret.ticker.pause()},egret.lifecycle.onResume=function(){egret.ticker.resume()},this.runGame()["catch"](function(t){console.log(t)})},e.prototype.runGame=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return console.log("url",window.location.href),[4,this.loadResource()];case 1:return t.sent(),this.createGameScene(),[2]}})})},e.prototype.loadResource=function(){return __awaiter(this,void 0,void 0,function(){var t,e;return __generator(this,function(i){switch(i.label){case 0:return i.trys.push([0,3,,4]),t=new LoadingUI,this.stage.addChild(t),[4,RES.loadConfig("resource/default.res.json","resource/")];case 1:return i.sent(),[4,RES.loadGroup("preload",0,t)];case 2:return i.sent(),this.stage.removeChild(t),[3,4];case 3:return e=i.sent(),console.error(e),[3,4];case 4:return[2]}})})},e.prototype.createGameScene=function(){return __awaiter(this,void 0,void 0,function(){var t,e,i,n,r,o,s,a,h=this;return __generator(this,function(c){return t=this.createBitmapByName("exit_png"),this.stage.addChild(t),t.width=80,t.height=80,t.x=10,t.y=5,t.touchEnabled=!0,t.addEventListener(egret.TouchEvent.TOUCH_TAP,function(){document.location.href="index.html"},this),e=this.createBitmapByName("setmap_png"),this.stage.addChild(e),e.width=80,e.height=80,e.x=10,e.y=115,e.touchEnabled=!0,e.addEventListener(egret.TouchEvent.TOUCH_TAP,this.setMap,this),i=this.createBitmapByName("kickoff_png"),this.stage.addChild(i),i.x=10,i.y=220,i.touchEnabled=!0,i.addEventListener(egret.TouchEvent.TOUCH_TAP,this.kickOff,this),this.messageContainer.width=300,this.messageContainer.height=200,this.messageBox.graphics.clear(),this.messageBox.graphics.beginFill(15658734),this.messageBox.graphics.drawRoundRect(0,0,300,200,15,15),this.messageBox.graphics.endFill(),this.messageContainer.addChild(this.messageBox),this.message.width=300,this.message.height=200,this.message.size=18,this.message.textColor=0,this.message.$setWordWrap(!0),this.message.type=egret.TextFieldType.INPUT,this.message.$setMultiline(!0),this.messageContainer.addChild(this.message),this.summaryContainer.x=1300,this.summaryContainer.y=30,this.summaryContainer.width=150,this.summaryContainer.height=200,this.stage.addChild(this.summaryContainer),this.summaryBox.graphics.clear(),this.summaryBox.graphics.beginFill(16240036,.8),this.summaryBox.graphics.drawRoundRect(0,0,150,200,15,15),this.summaryBox.graphics.endFill(),this.summaryContainer.addChild(this.summaryBox),this.summaryContent.width=150,this.summaryContent.height=200,this.summaryContent.size=18,this.summaryContent.textColor=0,this.summaryContent.$setWordWrap(!0),this.summaryContent.type=egret.TextFieldType.INPUT,this.summaryContent.$setMultiline(!0),this.summaryContainer.addChild(this.summaryContent),this.honorListContainer.width=880,this.honorListContainer.height=880,this.honorListBox.graphics.clear(),this.honorListBox.graphics.beginFill(4473924,.8),this.honorListBox.graphics.drawRoundRect(0,0,880,880,15,15),this.honorListBox.graphics.endFill(),this.honorListContainer.addChild(this.honorListBox),this.honorListText.width=880,this.honorListText.height=880,this.honorListText.size=22,this.honorListText.textColor=0,this.honorListText.$setWordWrap(!0),this.honorListText.type=egret.TextFieldType.INPUT,this.honorListText.$setMultiline(!0),this.honorListContainer.addChild(this.honorListText),this.login=this.createBitmapByName("login_png"),this.login.x=1200,this.login.y=10,this.login.touchEnabled=!0,this.login.addEventListener(egret.TouchEvent.TOUCH_TAP,this.loginGame,this),this.logout=this.createBitmapByName("logout_png"),this.logout.x=1200,this.logout.y=10,this.logout.touchEnabled=!0,this.logout.addEventListener(egret.TouchEvent.TOUCH_TAP,this.logoutGame,this),ScatterUtils.getIdentity().then(function(t){null==t?h.stage.addChild(h.login):(ScatterUtils.login(),h.stage.addChild(h.logout))}),n=this.createBitmapByName("play_png"),this.stage.addChild(n),n.x=1400,n.y=300,n.touchEnabled=!0,n.addEventListener(egret.TouchEvent.TOUCH_TAP,this.backgroundSound.bind(this,RES.getRes("glory_1_mp3").url),this),r=this.createBitmapByName("play_png"),this.stage.addChild(r),r.x=1400,r.y=350,r.touchEnabled=!0,r.addEventListener(egret.TouchEvent.TOUCH_TAP,this.backgroundSound.bind(this,RES.getRes("honor_1_mp3").url),this),o=this.createBitmapByName("play_png"),this.stage.addChild(o),o.x=1400,o.y=400,o.touchEnabled=!0,o.addEventListener(egret.TouchEvent.TOUCH_TAP,this.backgroundSound.bind(this,RES.getRes("easy_1_mp3").url),this),s=this.createBitmapByName("stop_png"),this.stage.addChild(s),s.x=1400,s.y=450,s.touchEnabled=!0,s.addEventListener(egret.TouchEvent.TOUCH_TAP,function(){h.backgroundMusicChannel&&h.backgroundMusicChannel.stop()},this),this.stage.addChild(this.textfield),a=window.location.href.substr(window.location.href.indexOf("=")+1),this.initBoard().then(function(){h.refreshHouse(a),h.interval=egret.setInterval(function(){return __awaiter(h,void 0,void 0,function(){var t,e=this;return __generator(this,function(i){switch(i.label){case 0:return[4,this.refreshHouse(a)];case 1:return i.sent(),this.updateSummaryBoard(),t=this.currentHouse.getProgress(),3==t&&(egret.setTimeout(function(){e.popHonorList()},this,5e3),this.interval&&egret.clearInterval(this.interval)),[2]}})})},h,5e3)}),[2]})})},e.prototype.initBoard=function(){return __awaiter(this,void 0,void 0,function(){var t,e=this;return __generator(this,function(i){return null==this.board&&(this.board=new Board(11,11),this.board.x=300,this.board.y=50,this.stage.addChild(this.board),t=this.board.getCellList(),t.map(function(t){var i=t.getXY();t.addEventListener(egret.TouchEvent.TOUCH_TAP,function(){if(null!=e.currentHouse){var n=e.currentHouse.getProgress();0==n||(1==n?e.joinGame(i.x,i.y,t.getPosition()):2==n&&(console.log("move triger"),e.move(i.x,i.y,t.getPosition())))}},e)})),[2]})})},e.prototype.popMessageBox=function(t){var e=this;this.stage.contains(this.messageContainer)||(this.messageContainer.x=this.stage.width/2-100,this.messageContainer.y=50,this.stage.addChild(this.messageContainer)),egret.clearTimeout(this.messageTimeout),this.messageTimeout=egret.setTimeout(function(){e.stage.removeChild(e.messageContainer)},this,4e3),this.message.text=t},e.prototype.popHonorList=function(){this.board.addChild(this.honorListContainer)},e.prototype.updateSummaryBoard=function(){this.currentHouse.getPlayerJsonList();this.summaryContent.text="总玩家数: "+this.currentHouse.getTotalJoinPlayers()+"\n"+("总EOS数:  "+this.currentHouse.getEOSInHouse()+"\n")+("Alive: "+this.currentHouse.getAlivePlayers())},e.prototype.createSafeAreaInBoard=function(t){var e=this;this.board.contains(this.safeAreaTop)||(this.board.addChild(this.safeAreaTop),this.board.addChild(this.safeAreaLeft),this.board.addChild(this.safeAreaRight),this.board.addChild(this.safeAreaBottom)),this.safeAreaTop.graphics.clear(),this.safeAreaTop.graphics.beginFill(65280,.2),this.safeAreaTop.graphics.drawRect(0,0,this.board.width,80*(5-t)),this.safeAreaTop.graphics.endFill(),this.safeAreaLeft.graphics.clear(),this.safeAreaLeft.graphics.beginFill(65280,.2),this.safeAreaLeft.graphics.drawRect(0,80*(5-t),80*(5-t),this.board.height-80*(5-t)*2),this.safeAreaLeft.graphics.endFill(),this.safeAreaRight.graphics.clear(),this.safeAreaRight.graphics.beginFill(65280,.2),this.safeAreaRight.graphics.drawRect(this.board.width-80*(5-t),80*(5-t),80*(5-t),this.board.height-80*(5-t)*2),this.safeAreaRight.graphics.endFill(),this.safeAreaBottom.graphics.clear(),this.safeAreaBottom.graphics.beginFill(65280,.2),this.safeAreaBottom.graphics.drawRect(0,this.board.height-80*(5-t),this.board.width,80*(5-t)),this.safeAreaBottom.graphics.endFill();var i=5-t;if(this.poisons.length<4*i)for(var n=this.poisons.length/4;i>n;n++)for(var r=function(t){var i,r;0==t?(i={x:0,y:80*n},r={x:800,y:80*n}):1==t?(i={x:80*n,y:0},r={x:80*n,y:800}):2==t?(i={x:800-80*n,y:800},r={x:800-80*n,y:0}):3==t&&(i={x:800,y:800-80*n},r={x:0,y:800-80*n}),o.animation({json:"poison_json",png:"poison_png",data:"poison",x:i.x,y:i.y}).then(function(t){t.$setScaleX(.6),t.$setScaleY(.6),t.$alpha=.5,t.play(-1),e.board.addChild(t),e.poisons.push(t),a(t,i,r)})},o=this,s=0;4>s;s++)r(s);var a=function(t,i,n){egret.Tween.get(t).to(n,6e3+4e3*Math.random(),egret.Ease.sineIn).wait(0).call(a.bind(e,t,n,i))}},e.prototype.updateObjectsInBoard=function(t){return __awaiter(this,void 0,void 0,function(){var e,i,n,r,o=this;return __generator(this,function(s){switch(s.label){case 0:return this.board.clearPlayers(),e=t.getBoard(),i=this.board.getCellList(),n=t.getProgress(),r=t.getStep(),[4,i.map(function(i,s){return __awaiter(o,void 0,void 0,function(){var o,a,h,c,l,u,p,g,d,f,y,m=this;return __generator(this,function(_){switch(_.label){case 0:return o=e[s],[4,i.getItem()];case 1:return a=_.sent(),h=o.item,[4,ItemUtils.createItemById(h)];case 2:return c=_.sent(),[4,t.getFullPlayersJsonByCellId(i.getID())];case 3:return l=_.sent(),l.length>0?(u=function(){return __awaiter(m,void 0,void 0,function(){var t,e;return __generator(this,function(i){switch(i.label){case 0:return[4,o.event_list.filter(function(t){return"move"==t.evt||"join"==t.evt})];case 1:return t=i.sent(),t.length>0?(e=t[t.length-1].who,[2,e]):[2,null]}})})},[4,u()]):[3,6];case 4:return p=_.sent(),[4,l.map(function(e){t.getPlayerByName(e.acc_name).then(function(t){t.isAlive()&&(0==t.x&&0==t.y&&t.setPosition(new egret.Point(i.x+10*Math.random(),i.y+10*Math.random())),m.board.putPlayer(t),t.getName()==p?m.board.setIndex(t,1):m.board.setIndex(t,0),egret.Tween.get(t).to({x:i.x+10*Math.random(),y:i.y+10*Math.random()},500,egret.Ease.sineIn))})})];case 5:_.sent(),2==n&&null!=a&&null!=c&&this.checkCellItemEffect(i,a,c),3==n?(g=e[60].event_list,d=g[g.length-1],this.checkBattersInCell(d.progress,d.step,o.event_list,i)):this.checkBattersInCell(n,r,o.event_list,i),_.label=6;case 6:return f=o.item_drop_ticks,0!=f?[3,8]:(c.x=15,c.y=15,[4,i.addItem(c)]);case 7:_.sent(),y=o.item_drop_triggered,1!=y||null!=a||5!=h&&8!=h&&13!=h||(console.log("prvItem",a),c.y=-300,egret.Tween.get(c).to({x:0,y:0},1500,egret.Ease.sineIn).wait(0).call(function(){console.log("item_fall_mp3"),m.actionSound(RES.getRes("item_fall_mp3").url)})),_.label=8;case 8:return[2]}})})})];case 1:return s.sent(),[2]}})})},e.prototype.updatePlayerProfileInStage=function(t){var e=this;this.stage.contains(this.playerProfileListContainer)||(this.stage.addChild(this.playerProfileListContainer),this.playerProfileListContainer.x=1200,this.playerProfileListContainer.y=100),this.playerProfileListContainer.removeChildren(),t.map(function(t,i){var n=e.createBitmapByName("portraitFrame_png");n.$setX(4),n.$setY(80*i+5),n.$setWidth(72),n.$setHeight(68);var r=t.getPlayerProfile().texture,o=new egret.Bitmap(r);if(o.$setX(0),o.$setY(80*i),o.$setWidth(80),o.$setHeight(72),e.playerProfileListContainer.addChild(n),e.playerProfileListContainer.addChild(o),t.isAlive())o.touchEnabled=!0,o.addEventListener(egret.TouchEvent.TOUCH_TAP,e.selectPlayer.bind(e,t),e);else{var s=new egret.ColorMatrixFilter([.3,.6,0,0,0,.3,.6,0,0,0,.3,.6,0,0,0,0,0,0,1,0]);o.filters=[s]}})},e.prototype.refreshHouse=function(t){return __awaiter(this,void 0,void 0,function(){var e=this;return __generator(this,function(i){switch(i.label){case 0:return[4,ScatterUtils.getGameInfo(parseInt(t)).then(function(t){return __awaiter(e,void 0,void 0,function(){var e;return __generator(this,function(i){switch(i.label){case 0:return console.log(t),t.rows.length>0?(e=t.rows[0],null!=this.currentHouse?[3,1]:(this.currentHouse=new House({name:"johny",bitmap:"house_png"},e),[3,3])):[3,5];case 1:return[4,this.currentHouse.updateHouse(e)];case 2:i.sent(),i.label=3;case 3:return[4,this.updateObjectsInBoard(this.currentHouse)];case 4:return i.sent(),this.createSafeAreaInBoard(this.currentHouse.getSafeAreaRadius()),this.updatePlayerProfileInStage(this.currentHouse.getPlayerList()),[3,6];case 5:this.currentHouse=null,this.popMessageBox("无游戏信息"),i.label=6;case 6:return[2]}})})})["catch"](function(t){console.error(t),e.currentHouse=null,e.popMessageBox("获取游戏信息失败")})];case 1:return i.sent(),[2]}})})},e.prototype.joinGame=function(t,e,i){var n=this;ScatterUtils.getIdentity().then(function(r){return null==r?void n.popMessageBox(ScatterUtils.message.authority):void ScatterUtils.joinGame(n.currentHouse.getID(),n.currentHouse.getJoinEos(),t,e).then(function(t){if(console.log("transaction",t),t.processed){n.popMessageBox("加入游戏！");var e=new Player("jump_png",{});n.board.putPlayer(e),e.setPosition(new egret.Point(i.x,i.y-300)),egret.Tween.get(e).to(i,300,egret.Ease.sineIn).wait(0).call(function(){n.actionSound(RES.getRes("player_fall_mp3").url)})}else t=JSON.parse(t),n.popMessageBox("加入游戏失败:"+t.error.details[0].message)})["catch"](function(t){console.error(t),n.popMessageBox("加入游戏失败:"+t)})})},e.prototype.setMap=function(){return __awaiter(this,void 0,void 0,function(){var t=this;return __generator(this,function(e){return ScatterUtils.getIdentity().then(function(e){return null==e?void t.popMessageBox(ScatterUtils.message.authority):void ScatterUtils.setMap(t.currentHouse.getID()).then(function(e){console.log("result",e),1==e.succ?t.popMessageBox("棋盘地图设定成功！"):t.popMessageBox("棋盘地图已经设定")})}),[2]})})},e.prototype.move=function(t,e,i){return __awaiter(this,void 0,void 0,function(){var n=this;return __generator(this,function(r){return ScatterUtils.getIdentity().then(function(r){return null==r?void n.popMessageBox(ScatterUtils.message.authority):void ScatterUtils.move(n.currentHouse.getID(),t,e).then(function(t){return __awaiter(n,void 0,void 0,function(){var e,n;return __generator(this,function(r){switch(r.label){case 0:return console.log("move transaction",t),t.processed?[3,1]:(t=JSON.parse(t),this.popMessageBox("移动失败："+t.error.details[0].message),[3,4]);case 1:return[4,ScatterUtils.getCurrentAccountName()];case 2:return e=r.sent(),[4,this.currentHouse.getPlayerList().filter(function(t){return t.getName()==e})];case 3:n=r.sent(),console.log("currentPlayer",n),n.length>0&&egret.Tween.get(n[0]).to(i,500,egret.Ease.sineIn),r.label=4;case 4:return[2]}})})})["catch"](function(t){console.error(t),n.popMessageBox("移动失败")})}),[2]})})},e.prototype.checkBattersInCell=function(t,e,i,n){return __awaiter(this,void 0,void 0,function(){var r,o,s;return __generator(this,function(a){switch(a.label){case 0:return[4,i.filter(function(i){return i.progress==t&&i.step==e&&"attack"==i.evt})];case 1:return r=a.sent(),console.log("attact_evt",r),r.length>0&&(o=n.getBattleTime(),s=(new Date).getTime(),console.log("time",s-o),s-o>=3e4&&(n.setBattleTime(s),this.attackTarget(n.getPosition()))),[2]}})})},e.prototype.checkCellItemEffect=function(t,e,i){return __awaiter(this,void 0,void 0,function(){var n=this;return __generator(this,function(r){return 1==e.getId()&&0==i.getId()&&this.animation({json:"explosion_json",png:"explosion_png",data:"explosion",x:t.x-20,y:t.y-30}).then(function(i){n.board.addChild(i),i.play(1),t.contains(e)&&t.removeChild(e),n.actionSound(RES.getRes("blow_mp3").url),n.actionSound(RES.getRes("destroyhuman_wav").url),setTimeout(function(){n.board.removeChild(i)},1e3)}),[2]})})},e.prototype.kickOff=function(){return __awaiter(this,void 0,void 0,function(){var t=this;return __generator(this,function(e){return ScatterUtils.getIdentity().then(function(e){return null==e?void t.popMessageBox(ScatterUtils.message.authority):t.currentHouse?void ScatterUtils.kickOff(t.currentHouse.getID()).then(function(e){console.log(e),e.processed?t.popMessageBox("游戏Kick Off成功！"):(e=JSON.parse(e),t.popMessageBox("KickOff游戏失败："+e.error.details[0].message))}):(console.log("no house selected"),void t.popMessageBox("游戏失效"))}),[2]})})},e.prototype.loginGame=function(){return __awaiter(this,void 0,void 0,function(){var t=this;return __generator(this,function(e){return ScatterUtils.login().then(function(e){e.login?(alert("欢迎: "+e.details),t.stage.contains(t.login)&&t.stage.removeChild(t.login),t.stage.contains(t.logout)||t.stage.addChild(t.logout)):alert(e.details)})["catch"](function(e){console.log("e",e),t.popMessageBox(e)}),[2]})})},e.prototype.logoutGame=function(){return __awaiter(this,void 0,void 0,function(){var t=this;return __generator(this,function(e){return ScatterUtils.logout().then(function(e){alert(e.details),e.logout&&(t.stage.contains(t.logout)&&t.stage.removeChild(t.logout),t.stage.contains(t.login)||t.stage.addChild(t.login))})["catch"](function(t){console.log("e",t),alert(t)}),[2]})})},e.prototype.animation=function(t){return __awaiter(this,void 0,void 0,function(){var e,i;return __generator(this,function(n){return e=new egret.MovieClipDataFactory(RES.getRes(t.json),RES.getRes(t.png)),i=new egret.MovieClip(e.generateMovieClipData(t.data)),i.x=t.x,i.y=t.y,[2,i]})})},e.prototype.showPlayerInfo=function(t){var e=this;this.board.contains(this.playerInfo)&&this.board.removeChild(this.playerInfo),this.playerInfo.graphics.clear(),this.playerInfo.graphics.beginFill(15658734),this.playerInfo.graphics.drawRoundRect(0,0,120,160,15,15),this.playerInfo.graphics.endFill(),this.playerInfo.x=t.x+50,this.playerInfo.y=t.y,this.board.addChild(this.playerInfo),this.player_name.x=this.playerInfo.x,this.player_name.y=this.playerInfo.y,this.player_name.size=18,this.player_name.textColor=0,this.player_name.text="玩家:"+t.getName(),this.board.addChild(this.player_name),this.player_hp.x=this.playerInfo.x,this.player_hp.y=this.playerInfo.y+20,this.player_hp.size=18,this.player_hp.textColor=0,this.player_hp.text="HP: "+t.getLife(),this.board.addChild(this.player_hp),this.player_weapon.x=this.playerInfo.x,this.player_weapon.y=this.playerInfo.y+40,this.player_weapon.size=18,this.player_weapon.textColor=0,this.player_weapon.text="武器: "+ItemUtils.getItemNameById(t.getWeapon()),this.board.addChild(this.player_weapon),this.player_attack.x=this.playerInfo.x,this.player_attack.y=this.playerInfo.y+60,this.player_attack.size=18,this.player_attack.textColor=0,this.player_attack.text="攻击力: "+t.getAttack(),this.board.addChild(this.player_attack),this.player_defense.x=this.playerInfo.x,this.player_defense.y=this.playerInfo.y+80,this.player_defense.size=18,this.player_defense.textColor=0,this.player_defense.text="防御力: "+t.getDefense(),this.board.addChild(this.player_defense),this.player_eos.x=this.playerInfo.x,this.player_eos.y=this.playerInfo.y+100,this.player_eos.size=18,this.player_eos.textColor=0,this.player_eos.text="EOS: "+t.getGold(),this.board.addChild(this.player_eos);var i=function(){var e="";return t.getItems().map(function(t){e=e+ItemUtils.getItemNameById(t)+"\n         "}),e};this.player_item.x=this.playerInfo.x,this.player_item.y=this.playerInfo.y+120,this.player_item.size=18,this.player_item.textColor=0,this.player_item.text="物品: "+i(),this.board.addChild(this.player_item),setTimeout(function(){e.board.removeChild(e.playerInfo),e.board.removeChild(e.player_name),e.board.removeChild(e.player_hp),e.board.removeChild(e.player_weapon),e.board.removeChild(e.player_attack),e.board.removeChild(e.player_defense),e.board.removeChild(e.player_eos),e.board.removeChild(e.player_item)},8e3)},e.prototype.recall=function(t){if(t||(t=this.selectedPlayer),t){this.unmountMovement(),this.clearRoute(t.getTask().action);var e=t.getTask().status,i=t.getHouse(),n=i.getPosition(),r=t.getBitmap();egret.Tween.removeTweens(r),e&&"completed"==e?egret.Tween.get(r).to(n,1e3,egret.Ease.sineIn):egret.Tween.get(r).to(n,0,egret.Ease.sineIn),t.setTask({action:"idle",target:null,status:null})}},e.prototype.initTask=function(t){var e=this;this.selectedPlayer?(this.unmountMovement(),this.selectedPlayer.setTask({action:t,target:null,status:null}),setTimeout(function(){e.mountMovement()},300)):console.log("no warrior selected")},e.prototype.showLife=function(t,e){var i,n=e.getLife();i=n.remain>=.6*n.full?60928:n.remain>=.4*n.full&&n.remain<.6*n.full?16776960:16711680,this._life.graphics.clear(),this._life.graphics.lineStyle(4,i),this._life.graphics.moveTo(e.getPosition().x,e.getPosition().y),this._life.graphics.lineTo(e.getPosition().x+n.remain,e.getPosition().y),t.addChild(this._life)},e.prototype.showText=function(t,e){this.textfield.x=e.x,this.textfield.y=e.y,this.textfield.size=22,this.textfield.textColor=0,this.textfield.text=t},e.prototype.selectPlayer=function(t){this.board.setIndex(t,1),this.showPlayerInfo(t),this.actionSound(RES.getRes("yes_mp3").url)},e.prototype.actionSound=function(t){var e=new egret.Sound;e.addEventListener(egret.Event.COMPLETE,function(t){e.play(0,1)},this),e.load(t)},e.prototype.backgroundSound=function(t){this.backgroundMusicChannel&&this.backgroundMusicChannel.stop(),this.backgroundMusic.addEventListener(egret.Event.COMPLETE,this.play,this),this.backgroundMusic.load(t)},e.prototype.play=function(){this.backgroundMusicChannel=this.backgroundMusic.play(0,0)},e.prototype.movePlayer=function(t){if(console.log("moving"),null!=this.selectedPlayer&&"undefined"!=typeof this.selectedPlayer){this.stage.contains(this._life)&&this.stage.removeChild(this._life);var e=this.selectedPlayer.getBitmap();egret.Tween.removeTweens(e);var i={x:e.x,y:e.y},n={x:t.stageX,y:t.stageY},r=this.selectedPlayer.getTask().action;this.drawRoute(i,n,r);var o={x:t.stageX-17,y:t.stageY-25};egret.Tween.get(e).to(o,3e3,egret.Ease.sineIn).wait(500).call(this.doAction.bind(this,this.selectedPlayer,r,o,n))}},e.prototype.mountMovement=function(){this.stage.addEventListener(egret.TouchEvent.TOUCH_TAP,this.movePlayer,this)},e.prototype.unmountMovement=function(){this.stage.removeEventListener(egret.TouchEvent.TOUCH_TAP,this.movePlayer,this)},e.prototype.doAction=function(t,e,i,n){var r=this;this.clearRoute(e);var o=t.getTask().target,s=null==o||null==o.getBitmap()?!1:o.getBitmap().hitTestPoint(n.x,n.y,!0);if(console.log("execute="+s),s){var a=this.createBitmapByName("sword_png");a.x=i.x,a.y=i.y,this.stage.addChild(a),"attack"==e?this.attackTarget(i).then(function(){t.setTask({action:"attack",target:null,status:"completed"}),r.recall(t)}):t.setTask({action:"enforce",target:o,status:"completed"}),setTimeout(function(){r.stage.removeChild(a),a=null},1e3)}else t.setTask({action:"idle",target:null})},e.prototype.attackTarget=function(t){var e=this,i=new egret.MovieClipDataFactory(RES.getRes("fighting_json"),RES.getRes("fighting_png")),n=new egret.MovieClip(i.generateMovieClipData("fighting"));n.x=t.x-20,n.y=t.y-25,this.board.addChild(n),n.play(5),this.actionSound(RES.getRes("shooting_mp3").url);var r=new egret.MovieClipDataFactory(RES.getRes("money_json"),RES.getRes("money_png")),o=new egret.MovieClip(r.generateMovieClipData("money"));return o.x=t.x,o.y=t.y-30,this.board.addChild(o),o.play(2),this.actionSound(RES.getRes("destroyhuman_wav").url),setTimeout(function(){e.board.removeChild(o)},2e3),new Promise(function(t,i){setTimeout(function(){e.board.removeChild(n),e.board.contains(e._life)&&e.board.removeChild(e._life),t()},7e3)})},e.prototype.drawRoute=function(t,e,i){this.clearRoute(i);var n,r,o;switch(i){case"attack":n=16711680,r=25,o=25;break;case"enforce":n=60928,r=10,o=50;break;default:n=16776960,r=10,o=50}this._route.graphics.lineStyle(2,n),this._route.graphics.moveTo(t.x,t.y),this._route.graphics.lineTo(e.x,e.y),this[i].x=e.x-r,this[i].y=e.y-o,this.stage.addChild(this[i])},e.prototype.clearRoute=function(t){this._route.graphics.clear(),this.stage.contains(this[t])&&this.stage.removeChild(this[t]),this.stage.contains(this._life)&&this.stage.removeChild(this._life)},e.prototype.createBitmapByName=function(t){var e=new egret.Bitmap,i=RES.getRes(t);return e.texture=i,e},e.prototype.mouseDown=function(t){this._touchStatus=!0,this._distance.x=t.stageX-t.target.x,this._distance.y=t.stageY-t.target.y,this.stage.addEventListener(egret.TouchEvent.TOUCH_MOVE,this.mouseMove,this)},e.prototype.mouseMove=function(t){if(this._touchStatus)try{t.target.x=t.stageX-this._distance.x,t.target.y=t.stageY-this._distance.y}catch(e){console.log(e)}},e.prototype.mouseUp=function(t){this._touchStatus=!1,this.stage.removeEventListener(egret.TouchEvent.TOUCH_MOVE,this.mouseMove,this)},e.prototype.removePlayerIcon=function(t){var e=this,i=t.getUUID();this.soilderIconList.map(function(t,n){t.key==i&&(e.stage.contains(t.icon)&&e.stage.removeChild(t.icon),e.soilderIconList.splice(n,1))})},e.prototype.refrashPlayerIcon=function(){this.soilderIconList.map(function(t,e){t.icon.x=110+68*e})},e.prototype.startAnimation=function(t){var e=this,i=new egret.HtmlTextParser,n=t.map(function(t){return i.parse(t)}),r=this.textfield,o=-1,s=function(){o++,o>=n.length&&(o=0);var t=n[o];r.textFlow=t;var i=egret.Tween.get(r);i.to({alpha:1},200),i.wait(2e3),i.to({alpha:0},200),i.call(s,e)};s()},e}(egret.DisplayObjectContainer);__reflect(Game.prototype,"Game");var House=function(t){function e(e,i){var n=t.call(this)||this;return n.life={full:100,remain:100},n.gold=100,n.colorMatrix=[.3,.6,0,0,0,.3,.6,0,0,0,.3,.6,0,0,0,0,0,0,1,0],n.game=i,n.createHouse(e),n}return __extends(e,t),e.prototype.createHouse=function(t){this.name=t.name,this.houseBitmap=this.createBitmapByName(t.bitmap),this.houseBitmap.width=150,this.houseBitmap.height=212,this.houseBitmap.touchEnabled=!0,this.addChild(this.houseBitmap),this.touchEnabled=!0,this.id=this.game.game_id,this.joinEos=this.game.join_eos,this.game_progress-this.game.game_progress,this.playerList=[],this.createPlayers(this.game.players)},e.prototype.updateHouse=function(t){this.game=t,this.game_progress-this.game.game_progress,this.updatePlayers(this.game.players)},e.prototype.updatePlayers=function(t){return __awaiter(this,void 0,void 0,function(){var e=this;return __generator(this,function(i){switch(i.label){case 0:return[4,t.map(function(t){return __awaiter(e,void 0,void 0,function(){var e;return __generator(this,function(i){switch(i.label){case 0:return[4,this.getPlayerByName(t.acc_name)];case 1:return e=i.sent(),null==e?this.createPlayer(t):e.updatePlayer(t),[2]}})})})];case 1:return i.sent(),[2]}})})},e.prototype.createPlayers=function(t){var e=this;t.map(function(t){e.createPlayer(t)})},e.prototype.createPlayer=function(t){var e=this.playerList.length%2==0?"avtar_male_png":"avtar_female_png",i=new Player(e,t);this.playerList.push(i)},e.prototype.createBitmapByName=function(t){var e=new egret.Bitmap,i=RES.getRes(t);return e.texture=i,e},e.prototype.getPlayerByName=function(t){return __awaiter(this,void 0,void 0,function(){var e;return __generator(this,function(i){switch(i.label){case 0:return[4,this.playerList.filter(function(e){return e.getName()==t
})];case 1:return e=i.sent(),e.length>0?[2,e[0]]:[2,null]}})})},e.prototype.getPlayerListByCellId=function(t){return __awaiter(this,void 0,void 0,function(){var e;return __generator(this,function(i){switch(i.label){case 0:return[4,this.playerList.filter(function(e){return e.getCellId()==t})];case 1:return e=i.sent(),[2,e]}})})},e.prototype.getBitmap=function(){return this.houseBitmap},e.prototype.getPlayerList=function(){return this.playerList},e.prototype.getPosition=function(){var t={x:this.x,y:this.y};return t},e.prototype.setPosition=function(t){this.x=t.x,this.y=t.y},e.prototype.getLife=function(){return this.life},e.prototype.setLife=function(t){this.life=t},e.prototype.destroy=function(){this.houseBitmap=null,this.playerList=[],this.game=null},e.prototype.getID=function(){return this.id},e.prototype.setID=function(t){return this.id=t},e.prototype.getJoinEos=function(){return this.joinEos},e.prototype.getGold=function(){return this.gold},e.prototype.setGold=function(t){this.gold=t},e.prototype.getHouseName=function(){return this.name},e.prototype.clearPlayerList=function(){this.playerList=[]},e.prototype.getBoard=function(){return this.game.board},e.prototype.getProgress=function(){return this.game.game_progress},e.prototype.getStep=function(){return this.game.step},e.prototype.getSafeAreaRadius=function(){return this.game.safe_area_radius},e.prototype.getFullPlayersJsonByCellId=function(t){return __awaiter(this,void 0,void 0,function(){var e;return __generator(this,function(i){switch(i.label){case 0:return[4,this.game.players.filter(function(e){return e.cell_id==t})];case 1:return e=i.sent(),[2,e]}})})},e.prototype.getPlayerJsonList=function(){return this.game.players},e.prototype.getTotalJoinPlayers=function(){return this.game.total_join_players},e.prototype.getDeadPlayers=function(){return this.game.dead_players},e.prototype.getAlivePlayers=function(){return this.game.total_join_players-this.game.dead_players},e.prototype.getEOSInHouse=function(){return this.getTotalJoinPlayers()*parseFloat(this.getJoinEos().substr(0,6))},e}(egret.DisplayObjectContainer);__reflect(House.prototype,"House");var Item=function(t){function e(e){var i=t.call(this)||this;return i.createItem(e),i}return __extends(e,t),e.prototype.createItem=function(t){this.itemBitMap=this.createBitmapByName(t),this.itemBitMap.width=50,this.itemBitMap.height=50,this.addChild(this.itemBitMap)},e.prototype.createBitmapByName=function(t){var e=new egret.Bitmap,i=RES.getRes(t);return e.texture=i,e},e.prototype.getBitmap=function(){return this.itemBitMap},e.prototype.getPosition=function(){var t={x:this.x,y:this.y};return t},e.prototype.setPosition=function(t){this.x=t.x,this.y=t.y},e.prototype.getId=function(){return this.id},e.prototype.setId=function(t){this.id=t},e.prototype.destroy=function(){this.itemBitMap=null},e}(egret.DisplayObjectContainer);__reflect(Item.prototype,"Item");var Cell=function(t){function e(e,i,n){var r=t.call(this)||this;return r.cellRect=new egret.Shape,r.task={action:"idle",target:null,status:null},r.position=new egret.Point(0,0),r.item=null,r.hasPoison=!1,r.battleTime=0,r.createCell(e,i,n),r}return __extends(e,t),e.prototype.createCell=function(t,e,i){this.id=i,this.cellRect.graphics.clear(),this.cellRect.graphics.lineStyle(1,0,.2),this.cellRect.graphics.beginFill(16240036,.5),this.cellRect.graphics.drawRect(0,0,80,80),this.cellRect.graphics.endFill(),this.addChild(this.cellRect),this.position=new egret.Point(80*t,80*e),this.x=this.position.x,this.y=this.position.y,this.cell_X_Y={x:t,y:e},this.touchEnabled=!0},e.prototype.createBitmapByName=function(t){var e=new egret.Bitmap,i=RES.getRes(t);return e.texture=i,e},e.prototype.getBitmap=function(){return this.cellBitmap},e.prototype.setTask=function(t){this.task=t},e.prototype.getTask=function(){return this.task},e.prototype.getPosition=function(){var t={x:this.x,y:this.y};return t},e.prototype.setPosition=function(t){this.x=t.x,this.y=t.y},e.prototype.destroy=function(){this.cellBitmap=null},e.prototype.getID=function(){return this.id},e.prototype.getXY=function(){return this.cell_X_Y},e.prototype.getItem=function(){return this.item},e.prototype.setItem=function(t){this.item=t},e.prototype.addItem=function(t){this.contains(this.item)&&(this.item.destroy(),this.removeChild(this.item)),this.item=t,this.addChild(this.item)},e.prototype.addPoison=function(t){this.hasPoison=!0,this.addChild(t)},e.prototype.getPoison=function(){return this.hasPoison},e.prototype.setBattleTime=function(t){this.battleTime=t},e.prototype.getBattleTime=function(){return this.battleTime},e.prototype.setIndex=function(t,e){this.setChildIndex(t,e)},e}(egret.DisplayObjectContainer);__reflect(Cell.prototype,"Cell");var LoadingUI=function(t){function e(){var e=t.call(this)||this;return e.createView(),e}return __extends(e,t),e.prototype.createView=function(){this.textField=new egret.TextField,this.addChild(this.textField),this.textField.y=300,this.textField.width=480,this.textField.height=100,this.textField.textAlign="center"},e.prototype.onProgress=function(t,e){this.textField.text="Loading..."+t+"/"+e},e}(egret.Sprite);__reflect(LoadingUI.prototype,"LoadingUI",["RES.PromiseTaskReporter"]);var Main=function(t){function e(){var e=t.call(this)||this;return e._touchStatus=!1,e._distance=new egret.Point,e.textfield=new egret.TextField,e.tmxTileMap=tiled.TMXTilemap,e._route=new egret.Shape,e._life=new egret.Shape,e.soilderIconList=[],e.houseList=[],e.board=null,e.backgroundMusic=new egret.Sound,e.playerInfo=new egret.Shape,e.player_name=new egret.TextField,e.player_hp=new egret.TextField,e.player_attack=new egret.TextField,e.player_defense=new egret.TextField,e.player_eos=new egret.TextField,e.player_item=new egret.TextField,e.player_weapon=new egret.TextField,e.safeAreaTop=new egret.Shape,e.safeAreaLeft=new egret.Shape,e.safeAreaRight=new egret.Shape,e.safeAreaBottom=new egret.Shape,e.messageContainer=new egret.DisplayObjectContainer,e.messageBox=new egret.Shape,e.message=new egret.TextField,e.townRandomName=["johny","kitty","peter"],e.num=0,e.canvas=document.getElementsByTagName("CANVAS")[0],e.addEventListener(egret.Event.ADDED_TO_STAGE,e.onAddToStage,e),e}return __extends(e,t),e.prototype.onAddToStage=function(t){egret.lifecycle.addLifecycleListener(function(t){t.onUpdate=function(){}}),egret.lifecycle.onPause=function(){egret.ticker.pause()},egret.lifecycle.onResume=function(){egret.ticker.resume()},this.runGame()["catch"](function(t){console.log(t)})},e.prototype.runGame=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return this.createGameScene(),[2]})})},e.prototype.loadResource=function(){return __awaiter(this,void 0,void 0,function(){var t,e;return __generator(this,function(i){switch(i.label){case 0:return i.trys.push([0,3,,4]),t=new LoadingUI,this.stage.addChild(t),[4,RES.loadConfig("resource/default.res.json","resource/")];case 1:return i.sent(),[4,RES.loadGroup("preload",0,t)];case 2:return i.sent(),this.stage.removeChild(t),[3,4];case 3:return e=i.sent(),console.error(e),[3,4];case 4:return[2]}})})},e.prototype.createGameScene=function(){return __awaiter(this,void 0,void 0,function(){var t,e,i,n,r,o=this;return __generator(this,function(s){switch(s.label){case 0:return[4,this.loadResource()];case 1:return s.sent(),t=this.createBitmapByName("city_png"),this.stage.addChild(t),t.width=80,t.height=100,t.x=10,t.y=5,t.touchEnabled=!0,t.addEventListener(egret.TouchEvent.TOUCH_TAP,this.createGame.bind(this,{name:"johny",bitmap:"house_png"}),this),this.login=this.createBitmapByName("login_png"),this.login.x=1150,this.login.y=10,this.login.touchEnabled=!0,this.login.addEventListener(egret.TouchEvent.TOUCH_TAP,this.loginGame,this),this.logout=this.createBitmapByName("logout_png"),this.logout.x=1150,this.logout.y=10,this.logout.touchEnabled=!0,this.logout.addEventListener(egret.TouchEvent.TOUCH_TAP,this.logoutGame,this),ScatterUtils.getIdentity().then(function(t){null==t?o.stage.addChild(o.login):(ScatterUtils.login(),o.stage.addChild(o.logout))}),e=this.createBitmapByName("play_png"),this.stage.addChild(e),e.x=1150,e.y=300,e.touchEnabled=!0,e.addEventListener(egret.TouchEvent.TOUCH_TAP,this.backgroundSound.bind(this,RES.getRes("glory_1_mp3").url),this),i=this.createBitmapByName("play_png"),this.stage.addChild(i),i.x=1150,i.y=350,i.touchEnabled=!0,i.addEventListener(egret.TouchEvent.TOUCH_TAP,this.backgroundSound.bind(this,RES.getRes("honor_1_mp3").url),this),n=this.createBitmapByName("play_png"),this.stage.addChild(n),n.x=1150,n.y=400,n.touchEnabled=!0,n.addEventListener(egret.TouchEvent.TOUCH_TAP,this.backgroundSound.bind(this,RES.getRes("easy_1_mp3").url),this),r=this.createBitmapByName("stop_png"),this.stage.addChild(r),r.x=1150,r.y=450,r.touchEnabled=!0,r.addEventListener(egret.TouchEvent.TOUCH_TAP,function(){o.backgroundMusicChannel&&o.backgroundMusicChannel.stop()},this),this.stage.addChild(this.textfield),this.refreshHouseList(),[2]}})})},e.prototype.popMessageBox=function(t){var e=this;this.stage.contains(this.messageContainer)||this.stage.addChild(this.messageContainer),this.messageContainer.x=this.stage.width/2-100,this.messageContainer.y=50,this.messageContainer.width=300,this.messageContainer.height=200,this.messageBox.graphics.clear(),this.messageBox.graphics.beginFill(15658734),this.messageBox.graphics.drawRoundRect(0,0,300,200,15,15),this.messageBox.graphics.endFill(),this.messageContainer.addChild(this.messageBox),this.message.width=300,this.message.height=200,this.message.size=18,this.message.textColor=0,this.message.text=t,this.message.$setWordWrap(!0),this.message.type=egret.TextFieldType.INPUT,this.message.$setMultiline(!0),this.messageContainer.addChild(this.message),setTimeout(function(){e.stage.removeChild(e.messageContainer)},4e3)},e.prototype.refreshHouseList=function(){return __awaiter(this,void 0,void 0,function(){var t=this;return __generator(this,function(e){switch(e.label){case 0:return[4,ScatterUtils.getAllGamesInfo().then(function(e){return __awaiter(t,void 0,void 0,function(){var t=this;return __generator(this,function(i){switch(i.label){case 0:return[4,this.houseList.map(function(e){t.stage.contains(e)&&(t.stage.removeChild(e),e.destroy(),e=null)})];case 1:return i.sent(),this.houseList=[],console.log(e),e.rows?[4,e.rows.map(function(e,i){t.createHouse({name:"johny",bitmap:"game_png"},e).then(function(e){e.setPosition(new egret.Point(170*(1+i),50)),t.stage.addChild(e),t.houseList.push(e)})})]:[3,3];case 2:return i.sent(),[3,4];case 3:this.popMessageBox("无游戏信息"),i.label=4;case 4:return[2]}})})})["catch"](function(e){console.error(e),t.popMessageBox("获取游戏信息失败")})];case 1:return e.sent(),[2]}})})},e.prototype.createGame=function(){var t=this;ScatterUtils.getIdentity().then(function(e){return null==e?void t.popMessageBox(ScatterUtils.message.authority):void ScatterUtils.createGame("1.0000 EOS").then(function(e){console.log("create",e),e.processed?t.refreshHouseList():(e=JSON.parse(e),t.popMessageBox("创建游戏失败:"+e.error.details[0].message))})["catch"](function(e){console.log(e),t.popMessageBox("取消创建游戏")})})},e.prototype.createHouse=function(t,e){return __awaiter(this,void 0,void 0,function(){var i;return __generator(this,function(n){return i=new House(t,e),i.addEventListener(egret.TouchEvent.TOUCH_TAP,function(){var t=i.getID();document.location.href="game.html?id="+t},this),[2,i]})})},e.prototype.loginGame=function(){return __awaiter(this,void 0,void 0,function(){var t=this;return __generator(this,function(e){return ScatterUtils.login().then(function(e){e.login?(alert("欢迎: "+e.details),t.stage.contains(t.login)&&t.stage.removeChild(t.login),t.stage.contains(t.logout)||t.stage.addChild(t.logout)):alert(e.details)})["catch"](function(e){console.log("e",e),t.popMessageBox(e)}),[2]})})},e.prototype.logoutGame=function(){return __awaiter(this,void 0,void 0,function(){var t=this;return __generator(this,function(e){return ScatterUtils.logout().then(function(e){alert(e.details),e.logout&&(t.stage.contains(t.logout)&&t.stage.removeChild(t.logout),t.stage.contains(t.login)||t.stage.addChild(t.login))})["catch"](function(t){console.log("e",t),alert(t)}),[2]})})},e.prototype.animation=function(t){return __awaiter(this,void 0,void 0,function(){var e,i;return __generator(this,function(n){return e=new egret.MovieClipDataFactory(RES.getRes(t.json),RES.getRes(t.png)),i=new egret.MovieClip(e.generateMovieClipData(t.data)),i.x=t.x,i.y=t.y,[2,i]})})},e.prototype.recall=function(t){if(t||(t=this.selectedPlayer),t){this.unmountMovement(),this.clearRoute(t.getTask().action);var e=t.getTask().status,i=t.getHouse(),n=i.getPosition(),r=t.getBitmap();egret.Tween.removeTweens(r),e&&"completed"==e?egret.Tween.get(r).to(n,1e3,egret.Ease.sineIn):egret.Tween.get(r).to(n,0,egret.Ease.sineIn),t.setTask({action:"idle",target:null,status:null})}},e.prototype.initTask=function(t){var e=this;this.selectedPlayer?(this.unmountMovement(),this.selectedPlayer.setTask({action:t,target:null,status:null}),setTimeout(function(){e.mountMovement()},300)):console.log("no warrior selected")},e.prototype.showLife=function(t,e){var i,n=e.getLife();i=n.remain>=.6*n.full?60928:n.remain>=.4*n.full&&n.remain<.6*n.full?16776960:16711680,this._life.graphics.clear(),this._life.graphics.lineStyle(4,i),this._life.graphics.moveTo(e.getPosition().x,e.getPosition().y),this._life.graphics.lineTo(e.getPosition().x+n.remain,e.getPosition().y),t.addChild(this._life)},e.prototype.showText=function(t,e){this.textfield.x=e.x,this.textfield.y=e.y,this.textfield.size=22,this.textfield.textColor=0,this.textfield.text=t},e.prototype.actionSound=function(t){var e=new egret.Sound;e.addEventListener(egret.Event.COMPLETE,function(t){e.play(0,1)},this),e.load(t)},e.prototype.backgroundSound=function(t){this.backgroundMusicChannel&&this.backgroundMusicChannel.stop(),this.backgroundMusic.addEventListener(egret.Event.COMPLETE,this.play,this),this.backgroundMusic.load(t)},e.prototype.play=function(){this.backgroundMusicChannel=this.backgroundMusic.play(0,0)},e.prototype.movePlayer=function(t){if(console.log("moving"),null!=this.selectedPlayer&&"undefined"!=typeof this.selectedPlayer){this.stage.contains(this._life)&&this.stage.removeChild(this._life);var e=this.selectedPlayer.getBitmap();egret.Tween.removeTweens(e);var i={x:e.x,y:e.y},n={x:t.stageX,y:t.stageY},r=this.selectedPlayer.getTask().action;this.drawRoute(i,n,r);var o={x:t.stageX-17,y:t.stageY-25};egret.Tween.get(e).to(o,3e3,egret.Ease.sineIn).wait(500).call(this.doAction.bind(this,this.selectedPlayer,r,o,n))}},e.prototype.mountMovement=function(){this.stage.addEventListener(egret.TouchEvent.TOUCH_TAP,this.movePlayer,this)},e.prototype.unmountMovement=function(){this.stage.removeEventListener(egret.TouchEvent.TOUCH_TAP,this.movePlayer,this)},e.prototype.doAction=function(t,e,i,n){var r=this;this.clearRoute(e);var o=t.getTask().target,s=null==o||null==o.getBitmap()?!1:o.getBitmap().hitTestPoint(n.x,n.y,!0);if(console.log("execute="+s),s){var a=this.createBitmapByName("sword_png");a.x=i.x,a.y=i.y,this.stage.addChild(a),"attack"==e?this.attackTarget(i).then(function(){t.setTask({action:"attack",target:null,status:"completed"}),r.recall(t)}):t.setTask({action:"enforce",target:o,status:"completed"}),setTimeout(function(){r.stage.removeChild(a),a=null},1e3)}else t.setTask({action:"idle",target:null})},e.prototype.attackTarget=function(t){var e=this,i=new egret.MovieClipDataFactory(RES.getRes("fight_json"),RES.getRes("fight_png")),n=new egret.MovieClip(i.generateMovieClipData("fight"));n.x=t.x,n.y=t.y,n.width=50,n.height=50,this.board.addChild(n),n.play(20),this.actionSound(RES.getRes("shooting_mp3").url);var r=new egret.MovieClipDataFactory(RES.getRes("money_json"),RES.getRes("money_png")),o=new egret.MovieClip(r.generateMovieClipData("money"));return o.x=t.x,o.y=t.y-30,this.board.addChild(o),o.play(2),this.actionSound(RES.getRes("destroyhuman_wav").url),setTimeout(function(){e.board.removeChild(o)},2e3),new Promise(function(t,i){setTimeout(function(){e.board.removeChild(n),e.board.contains(e._life)&&e.board.removeChild(e._life),t()},1e3)})},e.prototype.drawRoute=function(t,e,i){this.clearRoute(i);var n,r,o;switch(i){case"attack":n=16711680,r=25,o=25;break;case"enforce":n=60928,r=10,o=50;break;default:n=16776960,r=10,o=50}this._route.graphics.lineStyle(2,n),this._route.graphics.moveTo(t.x,t.y),this._route.graphics.lineTo(e.x,e.y),this[i].x=e.x-r,this[i].y=e.y-o,this.stage.addChild(this[i])},e.prototype.clearRoute=function(t){this._route.graphics.clear(),this.stage.contains(this[t])&&this.stage.removeChild(this[t]),this.stage.contains(this._life)&&this.stage.removeChild(this._life)},e.prototype.createBitmapByName=function(t){var e=new egret.Bitmap,i=RES.getRes(t);return e.texture=i,e},e.prototype.mouseDown=function(t){this._touchStatus=!0,this._distance.x=t.stageX-t.target.x,this._distance.y=t.stageY-t.target.y,this.stage.addEventListener(egret.TouchEvent.TOUCH_MOVE,this.mouseMove,this)},e.prototype.mouseMove=function(t){if(this._touchStatus)try{t.target.x=t.stageX-this._distance.x,t.target.y=t.stageY-this._distance.y}catch(e){console.log(e)}},e.prototype.mouseUp=function(t){this._touchStatus=!1,this.stage.removeEventListener(egret.TouchEvent.TOUCH_MOVE,this.mouseMove,this)},e.prototype.removePlayerIcon=function(t){var e=this,i=t.getUUID();this.soilderIconList.map(function(t,n){t.key==i&&(e.stage.contains(t.icon)&&e.stage.removeChild(t.icon),e.soilderIconList.splice(n,1))})},e.prototype.refrashPlayerIcon=function(){this.soilderIconList.map(function(t,e){t.icon.x=110+68*e})},e.prototype.startAnimation=function(t){var e=this,i=new egret.HtmlTextParser,n=t.map(function(t){return i.parse(t)}),r=this.textfield,o=-1,s=function(){o++,o>=n.length&&(o=0);var t=n[o];r.textFlow=t;var i=egret.Tween.get(r);i.to({alpha:1},200),i.wait(2e3),i.to({alpha:0},200),i.call(s,e)};s()},e}(egret.DisplayObjectContainer);__reflect(Main.prototype,"Main");var DebugPlatform=function(){function t(){}return t.prototype.getUserInfo=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return[2,{nickName:"username"}]})})},t.prototype.login=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return[2]})})},t}();__reflect(DebugPlatform.prototype,"DebugPlatform",["Platform"]),window.platform||(window.platform=new DebugPlatform);var Player=function(t){function e(e,i){var n=t.call(this)||this;return n.task={action:"idle",target:null,status:null},n.position=new egret.Point(0,0),n.items=[],n.createPlayer(e,i),n}return __extends(e,t),e.prototype.createPlayer=function(t,e){this.playerBitmap=this.createBitmapByName(t),this.playerBitmap.width=70,this.playerBitmap.height=70,this.playerProfile=this.createBitmapByName("profile_"+t),this.addChild(this.playerBitmap),this.setName(e.acc_name),this.setCellId(e.cell_id),this.setArmor(e.armor),this.setAttack(e.attack),this.setLife(e.hp),this.setDefense(e.defense),this.setItems(e.items),this.setWeapon(e.weapon),this.setGold(e.win_eos)},e.prototype.updatePlayer=function(t){this.setCellId(t.cell_id),this.setArmor(t.armor),this.setAttack(t.attack),this.setLife(t.hp),this.setDefense(t.defense),this.setItems(t.items),this.setWeapon(t.weapon),this.setGold(t.win_eos)},e.prototype.createBitmapByName=function(t){var e=new egret.Bitmap,i=RES.getRes(t);return e.texture=i,e},e.prototype.getBitmap=function(){return this.playerBitmap},e.prototype.getPlayerProfile=function(){return this.playerProfile},e.prototype.setTask=function(t){this.task=t},e.prototype.getTask=function(){return this.task},e.prototype.getHouse=function(){return this.house},e.prototype.getPosition=function(){var t={x:this.x,y:this.y};return t},e.prototype.setPosition=function(t){this.x=t.x,this.y=t.y},e.prototype.getName=function(){return this.accName},e.prototype.setName=function(t){this.accName=t},e.prototype.getLife=function(){return this.hp},e.prototype.setLife=function(t){this.hp=t},e.prototype.destroy=function(){this.playerBitmap=null},e.prototype.getUUID=function(){return this.uuid},e.prototype.getGold=function(){return this.gold},e.prototype.setGold=function(t){this.gold=t},e.prototype.getCellId=function(){return this.cell_id},e.prototype.setCellId=function(t){this.cell_id=t},e.prototype.getArmor=function(){return this.armor},e.prototype.setArmor=function(t){this.armor=t},e.prototype.getAttack=function(){return this.attack},e.prototype.setAttack=function(t){this.attack=t},e.prototype.getDefense=function(){return this.defense},e.prototype.setDefense=function(t){this.defense=t},e.prototype.getWeapon=function(){return this.weapon},e.prototype.setWeapon=function(t){this.weapon=t},e.prototype.getItems=function(){return this.items},e.prototype.setItems=function(t){this.items=t},e.prototype.isAlive=function(){return this.getLife()>0?!0:!1},e}(egret.DisplayObjectContainer);__reflect(Player.prototype,"Player");var ScatterUtils=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.getEOS=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return null==this.eos?[2,Eos(this.config)]:[2,this.eos]})})},e.connect=function(){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return t=this,[4,ScatterJS.scatter.connect("scatter")];case 1:return t.connected=e.sent(),[2,this.connected]}})})},e.login=function(){return __awaiter(this,void 0,void 0,function(){var t,e,i=this;return __generator(this,function(n){switch(n.label){case 0:return[4,this.connect()];case 1:if(n.sent(),!this.connected)return console.log("not connected"),[2,{login:!1,details:this.message.nowallet}];n.label=2;case 2:return n.trys.push([2,4,,5]),[4,ScatterJS.scatter.getIdentity({accounts:[this.network.EOS]}).then(function(t){return console.log("identities",t,ScatterJS.scatter.identity),i.currentAccount=t.accounts[0],i.eos=ScatterJS.scatter.eos(i.network.EOS,Eos),{login:!0,details:i.currentAccount.name}})];case 3:return t=n.sent(),[2,t];case 4:return e=n.sent(),[2,{login:!1,details:"未能使用钱包，可能是"+this.message.walletlock+"或者"+this.message.noidentity}];case 5:return[2]}})})},e.getAccountInfo=function(){return __awaiter(this,void 0,void 0,function(){var t,e;return __generator(this,function(i){switch(i.label){case 0:return null!=this.eos?[3,2]:(t=this,[4,this.getEOS()]);case 1:t.eos=i.sent(),i.label=2;case 2:return[4,this.eos.getAccount(this.currentAccount.name).then(function(t){return console.log(t),t})["catch"](function(t){return t})];case 3:return e=i.sent(),[2,e]}})})},e.getAllGamesInfo=function(){return __awaiter(this,void 0,void 0,function(){var t,e;return __generator(this,function(i){switch(i.label){case 0:return null!=this.eos?[3,2]:(t=this,[4,this.getEOS()]);case 1:t.eos=i.sent(),i.label=2;case 2:return[4,this.eos.getTableRows({json:!0,scope:"eat.chicken",code:"eat.chicken",table:"games"}).then(function(t){return console.log(t),t})["catch"](function(t){return t})];case 3:return e=i.sent(),[2,e]}})})},e.getGameInfo=function(t){return __awaiter(this,void 0,void 0,function(){var e,i;return __generator(this,function(n){switch(n.label){case 0:return null!=this.eos?[3,2]:(e=this,[4,this.getEOS()]);case 1:e.eos=n.sent(),n.label=2;case 2:return[4,this.eos.getTableRows({json:!0,scope:"eat.chicken",code:"eat.chicken",table:"games",limit:1,lower_bound:t,upper_bound:t+1}).then(function(t){return t})["catch"](function(t){return t})];case 3:return i=n.sent(),[2,i]}})})},e.createGame=function(t){return __awaiter(this,void 0,void 0,function(){var e;return __generator(this,function(i){switch(i.label){case 0:return[4,this.eos.transaction({actions:[{account:"eosio.token",name:"transfer",authorization:[{actor:this.currentAccount.name,permission:"active"}],data:{from:this.currentAccount.name,to:"eat.chicken",quantity:t,memo:""}}]}).then(function(t){return t})["catch"](function(t){return t})];case 1:return e=i.sent(),[2,e]}})})},e.joinGame=function(t,e,i,n){return __awaiter(this,void 0,void 0,function(){var r;return __generator(this,function(o){switch(o.label){case 0:return[4,this.eos.transaction({actions:[{account:"eosio.token",name:"transfer",authorization:[{actor:this.currentAccount.name,permission:"active"}],data:{from:this.currentAccount.name,to:"eat.chicken",quantity:e,memo:t+","+i+","+n}}]}).then(function(t){return console.log("res",t),t})["catch"](function(t){return t})];case 1:return r=o.sent(),[2,r]}})})},e.setMap=function(t){return __awaiter(this,void 0,void 0,function(){var e;return __generator(this,function(i){switch(i.label){case 0:return[4,fetch("http://114.115.135.201:52919/api?a=setmap&game_id="+t,{method:"GET"}).then(function(t){return t.json()}).then(function(t){return console.log(t),t})];case 1:return e=i.sent(),[2,e]}})})},e.kickOff=function(t){return __awaiter(this,void 0,void 0,function(){var e;return __generator(this,function(i){switch(i.label){case 0:return[4,this.eos.transaction({actions:[{account:"eat.chicken",name:"kickoff",authorization:[{actor:this.currentAccount.name,permission:"active"}],data:{who:this.currentAccount.name,game_id:t}}]}).then(function(t){return t})["catch"](function(t){return t})];case 1:return e=i.sent(),[2,e]}})})},e.move=function(t,e,i){return __awaiter(this,void 0,void 0,function(){var n;return __generator(this,function(r){switch(r.label){case 0:return[4,this.eos.transaction({actions:[{account:"eat.chicken",name:"move",authorization:[{actor:this.currentAccount.name,permission:"active"}],data:{who:this.currentAccount.name,game_id:t,row:e,column:i}}]}).then(function(t){return t})["catch"](function(t){return t})];case 1:return n=r.sent(),[2,n]}})})},e.logout=function(){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){try{return t=this.currentAccount.name,ScatterJS.scatter.forgetIdentity(),this.currentAccount=null,this.eos=null,[2,{logout:!0,details:t+this.message.logout}]}catch(i){return console.log(i),[2,{logout:!1,details:"登出失败"}]}return[2]})})},e.getCurrentAccountName=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return null!=this.currentAccount?[2,this.currentAccount.name]:[2,null]})})},e.getIdentity=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return[2,ScatterJS.scatter.identity]})})},e.nowseconds=function(){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return[4,fetch("http://114.115.135.201:52920/api/?a=now",{method:"GET"}).then(function(t){return t.json()}).then(function(t){return t})];case 1:return t=e.sent(),[2,t]}})})},e.eos=null,e.connected=!1,e.currentAccount=null,e.message={authority:"未授权用户，请先登录",walletlock:"钱包已上锁",noidentity:"未验证钱包身份",nowallet:"亲，还没有装钱包哟",login:"已登陆游戏",logout:"已登出游戏"},e.chain={main:"aca376f206b8fc25a6ed44dbdc66547c36c6c33e3a119ffbeaef943642f0e906",jungle:"038f4b0fc8ff18a4f0842a8f0564611f6e96e8535901dd45e43ac8691a1c4dca",dev:"cf057bbfb72640471fd910bcb67639c22df9f92470936cddc1ade0e2f2e7dc4f"},e.Blockchains={EOSIO:"eos",Ethereum:"eth",Tron:"trx"},e.network={EOS:{blockchain:"eos",protocol:"http",host:"114.115.135.201",port:8888,chainId:e.chain.dev},ETH:{blockchain:"eth",protocol:"http",host:"114.115.135.201",port:8888,chainId:e.chain.dev},TRX:{blockchain:"trx",protocol:"http",host:"114.115.135.201",port:8888,chainId:e.chain.dev}},e.config={keyProvider:["5KQwrPbwdL6PhXujxW37FSSQZ1JiwsST4cqQzDeyXtP79zkvFD3","5KRF8dr2fvHx9dVQyBqWwYhs7KvT8UdCb8Fy6hpWqHp6yZ1K6T3"],httpEndpoint:"http://114.115.135.201:8888",chainId:e.chain.dev,expireInSeconds:60,broadcast:!0,debug:!1,sign:!0},e}(Object);__reflect(ScatterUtils.prototype,"ScatterUtils");